<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ZKJ-KOGE ÊµÅÂä®ÊÄßÊ±†Â≠êÂÆûÊó∂Êï∞ÊçÆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --c-primary: #0078d4;
      --c-primary-dark: #005fa3;
      --c-bg: #f9f9f9;
      --c-text: #222;
      --c-sub: #555;
      --c-card: #fff;
      --c-skeleton: #e5e7eb;
      --grad-total: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
      background: var(--c-bg);
      color: var(--c-text);
      padding: 28px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* ---------- È°∂Ê†è ---------- */
    .topbar {
      width: 100%;
      max-width: 640px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
    }
    .title {
      font-size: 24px;
      font-weight: 700;
      color: var(--c-primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #spinner {
      display: none; /* ‰ªÖÂà∑Êñ∞Êó∂ÊòæÁ§∫ */
    }
    .spin {
      display: block;
      animation: rotate 1s linear infinite;
    }
    @keyframes rotate {
      to {
        transform: rotate(360deg);
      }
    }
    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .switch {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
    }
    .switch input {
      accent-color: var(--c-primary);
      cursor: pointer;
    }
    .link-btn {
      font-size: 18px;
      line-height: 18px;
    }

    /* ---------- Âç°Áâá ---------- */
    .cards {
      width: 100%;
      max-width: 640px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .row {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      background: var(--c-card);
      padding: 14px 20px 14px 16px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      position: relative;
      overflow: hidden;
      animation: fadeInUp 0.35s ease;
      column-gap: 12px;
    }
    .row::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      width: 6px; /* ‚Üë ÂΩ©Êù°Âä†ÂÆΩ */
      height: 100%;
      background: var(--stripe, #ccc);
    }
    .label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 600;
      white-space: nowrap;
    }
    .token-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      display: block;
    }
    .icon-fallback {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
    }
    .value {
      text-align: right;
      min-width: 152px;
    }
    .amount-label,
    .price-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--c-sub);
    }
    .value-num {
      font-size: 18px;
      font-variant-numeric: tabular-nums;
    }
    .value-price {
      font-size: 14px;
      font-variant-numeric: tabular-nums;
      margin-top: 2px;
    }
    @keyframes fadeInUp {
      0% {
        opacity: 0;
        transform: translateY(8px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ---------- ÊÄª‰ª∑ÂÄº ---------- */
    .total-wrap {
      margin: 22px 0 10px;
      padding: 10px 22px;
      border-radius: 12px;
      background: rgba(79, 172, 254, 0.12);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .total {
      font-size: 26px;
      font-weight: 700;
      background: var(--grad-total);
      -webkit-background-clip: text;
      color: transparent;
      white-space: nowrap;
    }

    .update-time {
      font-size: 14px;
      color: var(--c-sub);
      margin-bottom: 14px;
      cursor: default;
    }

    /* ---------- ÊåâÈíÆ ---------- */
    button,
    a.btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 24px;
      font-size: 16px;
      background: var(--c-primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.18s;
    }
    button:hover,
    a.btn:hover {
      background: var(--c-primary-dark);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* ---------- Skeleton ---------- */
    .skeleton {
      background: var(--c-skeleton);
      border-radius: 6px;
      animation: sFade 1.2s ease-in-out infinite;
    }
    @keyframes sFade {
      0% { opacity: 0.9 }
      50% { opacity: 0.4 }
      100% { opacity: 0.9 }
    }

    /* ---------- ÂìçÂ∫îÂºè ---------- */
    @media (max-width: 560px) {
      .token-icon,
      .icon-fallback {
        width: 26px;
        height: 26px;
      }
      .row {
        padding: 12px 14px 12px 12px;
        grid-template-columns: auto 1fr;
        grid-template-areas:
          "label value"
          "label2 value";        /* ËÆ©ÂêçÁß∞/Êï∞Èáè/‰ª∑ÂÄºËá™Âä®Êäò */
      }
      .value {
        text-align: left;
        margin-top: 6px;
        min-width: 0;
      }
      .controls {
        flex-direction: column;
        gap: 6px;
      }
    }
  </style>
</head>
<body>
  <!-- È°∂Ê†è -->
  <div class="topbar">
    <div class="title">
      ZKJ-KOGE ÊµÅÂä®ÊÄßÊ±†Â≠êÂÆûÊó∂Êï∞ÊçÆ
      <svg id="spinner" width="16" height="16" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round" stroke-dasharray="60" stroke-dashoffset="48"/>
      </svg>
    </div>

    <div class="controls">
      <label class="switch">
        <input type="checkbox" id="autoCb" checked />
        Ëá™Âä®Âà∑Êñ∞
      </label>

      <a class="btn link-btn" href="https://debank.com/profile/0x099f84de4fb511e861ca8f635623eae409405873" target="_blank">üì¶ Ê±†Â≠ê‰ΩôÈ¢ù</a>
    </div>
  </div>

  <!-- Âç°Áâá -->
  <div class="cards" id="rows"></div>

  <!-- ÊÄª‰ª∑ÂÄº -->
  <div class="total-wrap">
    <span class="total" id="totalValue">üí∞</span>
  </div>
  <div class="update-time" id="updateTime"></div>

  <button id="refreshBtn" class="btn">‚ü≥ Âà∑Êñ∞‰ΩôÈ¢ù</button>

  <!-- ‰æùËµñ -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.css"/>

  <script>
  ;(async () => {
    /* ------------ ÈÖçÁΩÆ ------------ */
    const CFG = {
      ADDRESS: "0x099f84de4fb511e861ca8f635623eae409405873",
      TOKENS: [
        { symbol: "ZKJ", address: "0xc71b5f631354be6853efe9c3ab6b9590f8302e81", logo: "./zkj.png", color: "#1e88ff", decimals: null },
        { symbol: "KOGE", address: "0xe6df05ce8c8301223373cf5b969afcb1498c5528", logo: "./koge.png", color: "#ff9800", decimals: null },
      ],
      RPC: "https://bsc-dataseed.binance.org/",
      MULTICALL: "0x1Ee38d535d541c55C9dae27B12edf090C608E6Fb",
      TIMEOUT: 8000,
      RETRY: 1,
      INTERVAL: 60000,
      PRICE_CACHE: 30000,
    };

    /* ------------ DOM ------------ */
    const rowsBox   = document.getElementById("rows");
    const totalDom  = document.getElementById("totalValue");
    const timeDom   = document.getElementById("updateTime");
    const spinner   = document.getElementById("spinner");
    const autoCb    = document.getElementById("autoCb");
    const refreshBtn= document.getElementById("refreshBtn");

    /* ------------ Ethers ------------ */
    const provider = new ethers.providers.JsonRpcProvider(CFG.RPC);
    const ERC20_ABI = ["function decimals() view returns(uint8)", "function balanceOf(address) view returns(uint256)"];
    const MC_ABI   = ["function aggregate(tuple(address target, bytes callData)[]) view returns(uint256,bytes[])"];
    const iface = new ethers.utils.Interface(ERC20_ABI);
    const multicall = new ethers.Contract(CFG.MULTICALL, MC_ABI, provider);

    /* ------------ Â∞èÂ∑•ÂÖ∑ ------------ */
    async function fetchJSON(url, timeout = CFG.TIMEOUT, retry = CFG.RETRY) {
      for (let i = 0; i <= retry; i++) {
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), timeout);
        try {
          const res = await fetch(url, { signal: ctrl.signal });
          clearTimeout(t);
          if (!res.ok) throw new Error(res.statusText);
          return res.json();
        } catch (e) {
          if (i === retry) throw e;
          await new Promise(r => setTimeout(r, 600));
        }
      }
    }

    /* ÁºìÂ≠ò‰ª∑Ê†º */
    const getCached = a => {
      try {
        const { p, ts } = JSON.parse(localStorage.getItem("p_" + a) || "{}");
        if (Date.now() - ts < CFG.PRICE_CACHE) return p;
      } catch {}
      return null;
    };
    const setCached = (a, p) => localStorage.setItem("p_" + a, JSON.stringify({ p, ts: Date.now() }));

    /* Â§öÁ∫ßÂÖúÂ∫ï‰ª∑Ê†º */
    async function getPrice(addr) {
      const c = getCached(addr);
      if (c) return c;
      const lower = addr.toLowerCase();
      const attempts = [
        async () => {
          const j = await fetchJSON(`https://api.dexscreener.com/latest/dex/tokens/${lower}`);
          const p = (j.pairs || []).find(x => ["USDT", "USDC"].includes(x.quoteToken.symbol) && x.liquidity.usd > 5000);
          if (p) return +p.priceUsd;
          throw 0;
        },
        async () => {
          const j = await fetchJSON(`https://api.dexscreener.com/latest/dex/search/?q=${lower}`);
          const p = (j.pairs || []).find(x => ["USDT", "USDC"].includes(x.quoteToken.symbol) && x.liquidity.usd > 5000);
          if (p) return +p.priceUsd;
          throw 0;
        },
        async () => {
          const j = await fetchJSON(`https://api.geckoterminal.com/api/v2/simple/networks/bsc/token_price/${lower}`);
          const v = +Object.values(j.data.attributes.token_prices)[0];
          if (v) return v;
          throw 0;
        },
        async () => {
          const j = await fetchJSON(`https://api.pancakeswap.info/api/v2/tokens/${lower}`);
          const v = +j.data?.price;
          if (v) return v;
          throw 0;
        },
      ];
      for (const fn of attempts) {
        try {
          const p = await fn();
          setCached(addr, p);
          return p;
        } catch {}
      }
      throw new Error("‰ª∑Ê†ºÊé•Âè£ÂÖ®ÈÉ®Â§±Êïà");
    }

    async function ensureDecimals(t) {
      if (t.decimals != null) return;
      t.decimals = await new ethers.Contract(t.address, ERC20_ABI, provider).decimals().catch(() => 18);
    }
    async function getBalances(tokens, addr) {
      const calls = tokens.map(t => [t.address, iface.encodeFunctionData("balanceOf", [addr])]);
      const [, data] = await multicall.aggregate(calls);
      return data.map(x => ethers.BigNumber.from(x));
    }

    /* ------------ Skeleton ------------ */
    function skeleton() {
      rowsBox.innerHTML = "";
      CFG.TOKENS.forEach(t => {
        const div = document.createElement("div");
        div.className = "row";
        div.style.setProperty("--stripe", t.color);
        div.innerHTML = `
          <div class="label">
            <img class="token-icon" src="${t.logo}" referrerpolicy="no-referrer"
                 onerror="this.style.display='none';this.nextElementSibling.classList.add('icon-fallback')" />
            <span class="icon-fallback" style="display:none;background:${t.color}">${t.symbol[0]}</span>${t.symbol}
          </div>
          <div class="value">
            <span class="amount-label">Êï∞Èáè</span>
            <div class="skeleton" style="width:120px;height:20px"></div>
            <span class="price-label">‰ª∑ÂÄº</span>
            <div class="skeleton" style="width:100px;height:18px"></div>
          </div>
        `;
        rowsBox.appendChild(div);
      });
      totalDom.textContent = "üí∞";
      timeDom.textContent = "";
    }

    /* Ê†ºÂºèÂåñÊï∞Â≠óÔºöÊï∞Èáè  ‚â•1 ‰øùÁïô 2 ‰ΩçÔºåÂ∞è‰∫é 1 ‰øùÁïô 4 ‰Ωç */
    const fmtQty = n => (n >= 1 ? n.toLocaleString(undefined, { maximumFractionDigits: 2 }) : n.toFixed(4));
    /* Âçï‰ª∑Ê†ºÂºèÔºöÂêå‰∏ä */
    const fmtPrice = n => (n >= 1 ? n.toFixed(2) : n.toFixed(4));

    /* ------------ Âà∑Êñ∞‰∏ªÊµÅÁ®ã ------------ */
    async function refresh() {
      skeleton();
      spinner.classList.add("spin");
      refreshBtn.disabled = true;
      refreshBtn.textContent = "Âà∑Êñ∞‰∏≠‚Ä¶";
      try {
        await Promise.all(CFG.TOKENS.map(ensureDecimals));
        const bals = await getBalances(CFG.TOKENS, CFG.ADDRESS);
        const prices = await Promise.all(CFG.TOKENS.map(t => getPrice(t.address)));

        rowsBox.innerHTML = "";
        let total = 0;
        CFG.TOKENS.forEach((t, i) => {
          const human = parseFloat(ethers.utils.formatUnits(bals[i], t.decimals));
          const price = prices[i];
          const usd = Math.round(human * price);
          total += usd;

          const row = document.createElement("div");
          row.className = "row";
          row.style.setProperty("--stripe", t.color);
          row.innerHTML = `
            <div class="label">
              <img class="token-icon" src="${t.logo}" referrerpolicy="no-referrer"
                   onerror="this.style.display='none';this.nextElementSibling.classList.add('icon-fallback')" />
              <span class="icon-fallback" style="display:none;background:${t.color}">${t.symbol[0]}</span>${t.symbol}
            </div>
            <div class="value">
              <span class="amount-label">Êï∞Èáè</span>
              <span class="value-num" title="${human}">${fmtQty(human)}</span>
              <span class="price-label">‰ª∑ÂÄº</span>
              <span class="value-price">‚âà $${usd.toLocaleString()} @ $${fmtPrice(price)}</span>
            </div>
          `;
          rowsBox.appendChild(row);
        });

        totalDom.textContent = `üí∞ ÊÄª‰ª∑ÂÄºÔºö$${total.toLocaleString()}`;
        timeDom.dataset.ts = Date.now();
        updateRelativeTime();
      } catch (e) {
        Toastify({
          text: "‚ùå Êï∞ÊçÆËé∑ÂèñÂ§±Ë¥•Ôºö" + e.message,
          duration: 3500,
          gravity: "top",
          close: true,
          style: { background: "#e11d48" },
        }).showToast();
        totalDom.textContent = "ÊÄª‰ª∑ÂÄºËé∑ÂèñÂ§±Ë¥•";
      } finally {
        spinner.classList.remove("spin");
        refreshBtn.disabled = false;
        refreshBtn.textContent = "‚ü≥ Âà∑Êñ∞‰ΩôÈ¢ù";
      }
    }

    /* ------------ Áõ∏ÂØπÊó∂Èó¥ ------------ */
    function updateRelativeTime() {
      const ts = Number(timeDom.dataset.ts);
      if (!ts) return;
      const diff = Math.floor((Date.now() - ts) / 1000);
      const text =
        diff < 5 ? "ÂàöÂàö" : diff < 60 ? diff + " ÁßíÂâç" : Math.floor(diff / 60) + " ÂàÜÈíüÂâç";
      timeDom.textContent = text;
    }
    setInterval(updateRelativeTime, 5000);

    /* ------------ ‰∫ã‰ª∂&Ëá™Âä®Âà∑Êñ∞ ------------ */
    refreshBtn.onclick = refresh;
    let timer = setInterval(refresh, CFG.INTERVAL);
    autoCb.onchange = () => {
      if (autoCb.checked) timer = setInterval(refresh, CFG.INTERVAL);
      else clearInterval(timer);
    };

    refresh(); /* È¶ñÊ¨°Âä†ËΩΩ */
  })();
  </script>
</body>
</html>
